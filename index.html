<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç‡Ÿé¤Šå¸« - å€‹äººè¨­å®š</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .container { max-width: 600px; padding-top: 20px; }
        .card { border: none; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header { background-color: #06c755; color: white; border: none; padding: 20px; text-align: center; }
        .btn-primary { background-color: #06c755; border: none; border-radius: 12px; padding: 12px; font-size: 1.1rem; font-weight: bold; }
        .btn-primary:hover { background-color: #05b34c; }
        .form-label { font-weight: 600; color: #333; }
        .form-control, .form-select { border-radius: 10px; padding: 10px; border: 1px solid #e1e4e8; }
        .loading { display: none; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="m-0">âš™ï¸ è¨­å®šèº«é«”æ•¸å€¼</h3>
            <small>è®“æˆ‘å€‘ç‚ºæ‚¨é‡èº«æ‰“é€  TDEE</small>
        </div>
        <div class="card-body p-4">
            <form id="profileForm">
                <input type="hidden" id="userId" name="userId">
                <input type="hidden" id="nickname" name="nickname">

                <div class="row g-3">
                    <div class="col-6">
                        <label class="form-label">æ€§åˆ¥</label>
                        <select class="form-select" id="gender" required>
                            <option value="male">ç”·ç”Ÿ ğŸ™‹â€â™‚ï¸</option>
                            <option value="female">å¥³ç”Ÿ ğŸ™‹â€â™€ï¸</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label">å¹´é½¡</label>
                        <input type="number" class="form-control" id="age" placeholder="25" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label">èº«é«˜ (cm)</label>
                        <input type="number" class="form-control" id="height" placeholder="175" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label">é«”é‡ (kg)</label>
                        <input type="number" class="form-control" id="weight" placeholder="70" required>
                    </div>
                </div>

                <div class="mt-3">
                    <label class="form-label">æ—¥å¸¸æ´»å‹•é‡</label>
                    <select class="form-select" id="activity" required>
                        <option value="1.2">ğŸ›Œ ä¹…å (å¹¾ä¹ä¸é‹å‹•)</option>
                        <option value="1.375">ğŸš¶ è¼•åº¦ (æ¯é€±é‹å‹• 1-3 å¤©)</option>
                        <option value="1.55">ğŸƒ ä¸­åº¦ (æ¯é€±é‹å‹• 3-5 å¤©)</option>
                        <option value="1.725">ğŸ‹ï¸ é«˜åº¦ (æ¯é€±é‹å‹• 6-7 å¤©)</option>
                    </select>
                </div>

                <div class="mt-3 mb-4">
                    <label class="form-label">ç›®æ¨™</label>
                    <select class="form-select" id="goal" required>
                        <option value="lose">ğŸ“‰ æ¸›è„‚ (ç†±é‡èµ¤å­— 15%)</option>
                        <option value="maintain">âš–ï¸ ç¶­æŒé«”é‡</option>
                        <option value="gain">ğŸ’ª å¢è‚Œ (ç†±é‡ç›ˆé¤˜ 10%)</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary w-100" id="submitBtn">å„²å­˜è¨­å®š</button>
                <div class="loading text-muted" id="loadingMsg">è³‡æ–™è™•ç†ä¸­ï¼Œè«‹ç¨å€™... ğŸ”„</div>
            </form>
        </div>
    </div>
</div>

<script>
    // ğŸ”´ ğŸ”´ ğŸ”´ è«‹ä¿®æ”¹é€™è£¡ ğŸ”´ ğŸ”´ ğŸ”´
    // 1. é€™è£¡å…ˆå¡«ç©ºå­—ä¸²ï¼Œç­‰ä¸€ä¸‹ç”³è«‹å¥½ LINE LIFF ID å†å›ä¾†å¡«
    const LIFF_ID = "2008846678-Niw8fld9";
    // 2. è«‹æŠŠä½  n8n Webhook çš„ Production URL è²¼åœ¨å¼•è™Ÿè£¡
    const N8N_WEBHOOK_URL = "https://evann8n.app.n8n.cloud/webhook/update-profile"; 
    // ğŸ”´ ğŸ”´ ğŸ”´ ä¿®æ”¹çµæŸ ğŸ”´ ğŸ”´ ğŸ”´


    // åˆå§‹åŒ– LIFF
    async function main() {
        // å¦‚æœé‚„æ²’å¡« LIFF IDï¼Œå…ˆè·³éåˆå§‹åŒ– (æ–¹ä¾¿ä½ åœ¨é›»è…¦ç€è¦½å™¨æ¸¬è©¦æ’ç‰ˆ)
        if (!LIFF_ID) {
            console.log("å°šæœªè¨­å®š LIFF IDï¼Œè·³éåˆå§‹åŒ–");
            return;
        }

        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                // å–å¾—ç”¨æˆ¶è³‡æ–™
                const profile = await liff.getProfile();
                document.getElementById('userId').value = profile.userId;
                document.getElementById('nickname').value = profile.displayName;
            }
        } catch (err) {
            console.error("LIFF Initialization failed", err);
        }
    }
    main();

    // é€å‡ºè¡¨å–®
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const btn = document.getElementById('submitBtn');
        const loading = document.getElementById('loadingMsg');
        
        // é–å®šæŒ‰éˆ•é¿å…é‡è¤‡æŒ‰
        btn.disabled = true;
        btn.innerText = "å‚³é€ä¸­...";
        loading.style.display = 'block';

        // æ”¶é›†è³‡æ–™
        const formData = {
            // å¦‚æœåœ¨é›»è…¦ç€è¦½å™¨æ¸¬è©¦æŠ“ä¸åˆ° IDï¼Œçµ¦ä¸€å€‹æ¸¬è©¦ ID
            user_id: document.getElementById('userId').value || "TEST_USER_001", 
            nickname: document.getElementById('nickname').value || "æ¸¬è©¦ç”¨æˆ¶",
            gender: document.getElementById('gender').value,
            age: document.getElementById('age').value,
            height: document.getElementById('height').value,
            weight: document.getElementById('weight').value,
            activity: document.getElementById('activity').value,
            goal: document.getElementById('goal').value
        };

        try {
            // å‚³é€çµ¦ n8n
            const response = await fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                alert('âœ… è¨­å®šæˆåŠŸï¼æ‚¨çš„ TDEE å·²æ›´æ–°ã€‚');
                if (liff.isInClient()) {
                    liff.closeWindow(); // åœ¨ LINE è£¡é¢å°±é—œé–‰è¦–çª—
                }
            } else {
                alert('âŒ è¨­å®šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ n8n é€£ç·šã€‚');
            }
        } catch (error) {
            alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "å„²å­˜è¨­å®š";
            loading.style.display = 'none';
        }
    });
</script>

</body>
</html>
