<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI ç‡Ÿé¤Šå¸« - å¥åº·å„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #000;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; }
        .date-item.active { background-color: #000; color: #fff; transform: scale(1.05); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .date-item { transition: all 0.2s ease; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen overflow-hidden flex flex-col items-center">

    <div class="w-full max-w-md bg-gray-50 h-full shadow-2xl flex flex-col relative overflow-y-auto no-scrollbar">
        
        <div class="bg-black text-white px-5 py-4 flex justify-between items-center sticky top-0 z-20 shadow-md shrink-0">
            <div class="flex items-center gap-2">
                <span class="font-bold text-lg">AI ç‡Ÿé¤Šå¸« <span class="text-xs bg-indigo-500 px-1 rounded ml-1">v18.0 Pro</span></span>
            </div>
            <div class="flex gap-3">
                <div onclick="fetchData('manual')" class="p-2 hover:bg-gray-800 rounded-full transition-colors cursor-pointer">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </div>
            </div>
        </div>

        <div id="date-nav-container" class="bg-white border-b border-gray-100 py-3 px-4 sticky top-[60px] z-10 overflow-x-auto no-scrollbar flex gap-3 shrink-0">
        </div>

        <div id="loading-overlay" class="hidden absolute inset-0 bg-white/90 z-50 flex items-center justify-center backdrop-blur-sm">
            <div class="flex flex-col items-center">
                <div class="loader mb-3 border-t-orange-500"></div>
                <div class="text-sm text-gray-600 font-bold tracking-wide animate-pulse">è™•ç†ä¸­...</div>
            </div>
        </div>

        <div class="p-4 space-y-4 pb-20 overflow-y-auto">

            <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100 relative overflow-hidden">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2"> ğŸ‘¤ å€‹äººç‹€æ…‹</h3>
                    <button onclick="toggleSettings(true)" class="text-xs flex items-center gap-1 text-gray-400 hover:text-gray-600 bg-gray-50 px-2 py-1 rounded-lg transition-colors">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        è¨­å®š
                    </button>
                </div>
                <div class="grid grid-cols-3 gap-2 text-center divide-x divide-gray-100">
                    <div><div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">TDEE</div><div class="font-bold text-xl text-gray-800" id="disp-tdee">--</div></div>
                    <div><div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">BMR</div><div class="font-bold text-xl text-gray-800" id="disp-bmr">--</div></div>
                    <div><div class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">é«”é‡</div><div class="font-bold text-xl text-gray-800" id="disp-weight">--</div></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
                <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2"> ğŸ“Š <span id="display-date-title">ä»Šæ—¥</span>æ”å–é€²åº¦</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-1 relative z-10"><span class="text-xs text-gray-500 font-medium"> ğŸ”¥ ç†±é‡</span><span id="percent-cal" class="text-xs text-orange-500 font-bold">0%</span></div>
                        <div class="flex items-baseline gap-1 relative z-10"><span id="val-cal" class="text-xl font-bold text-gray-800">0</span><span class="text-xs text-gray-400">/ <span id="goal-cal">--</span></span></div>
                        <div class="w-full bg-orange-200/50 rounded-full h-1.5 mt-2"><div id="bar-cal" class="bg-orange-500 h-1.5 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div></div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-1 relative z-10"><span class="text-xs text-gray-500 font-medium"> ğŸ¥š è›‹ç™½è³ª</span><span id="percent-pro" class="text-xs text-blue-500 font-bold">0%</span></div>
                        <div class="flex items-baseline gap-1 relative z-10"><span id="val-pro" class="text-xl font-bold text-gray-800">0</span><span class="text-xs text-gray-400">/ <span id="goal-pro">--</span>g</span></div>
                        <div class="w-full bg-blue-200/50 rounded-full h-1.5 mt-2"><div id="bar-pro" class="bg-blue-500 h-1.5 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div></div>
                    </div>
                    <div class="bg-green-50 p-3 rounded-xl border border-green-100 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-1 relative z-10"><span class="text-xs text-gray-500 font-medium"> ğŸš ç¢³æ°´</span><span id="percent-carb" class="text-xs text-green-500 font-bold">0%</span></div>
                        <div class="flex items-baseline gap-1 relative z-10"><span id="val-carb" class="text-xl font-bold text-gray-800">0</span><span class="text-xs text-gray-400">/ <span id="goal-carb">--</span>g</span></div>
                        <div class="w-full bg-green-200/50 rounded-full h-1.5 mt-2"><div id="bar-carb" class="bg-green-500 h-1.5 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div></div>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-100 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-1 relative z-10"><span class="text-xs text-gray-500 font-medium"> ğŸ¥‘ è„‚è‚ª</span><span id="percent-fat" class="text-xs text-yellow-500 font-bold">0%</span></div>
                        <div class="flex items-baseline gap-1 relative z-10"><span id="val-fat" class="text-xl font-bold text-gray-800">0</span><span class="text-xs text-gray-400">/ <span id="goal-fat">--</span>g</span></div>
                        <div class="w-full bg-yellow-200/50 rounded-full h-1.5 mt-2"><div id="bar-fat" class="bg-yellow-500 h-1.5 rounded-full transition-all duration-700 ease-out" style="width: 0%"></div></div>
                    </div>
                </div>

                <button onclick="shareAchievement()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform hover:shadow-xl">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                    ç”Ÿæˆä»Šæ—¥æˆ°å ± (æ‰“å¡ç”¨)
                </button>

                <button onclick="shareCoachReport()" class="w-full mt-3 bg-gray-800 text-gray-200 font-bold py-3 rounded-xl shadow-sm flex items-center justify-center gap-2 active:scale-95 transition-transform border border-gray-700 hover:bg-gray-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    ç”Ÿæˆå°ˆæ¥­æ•¸æ“š (çµ¦æ•™ç·´)
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                <div class="p-5 flex justify-between items-center border-b border-gray-100 bg-gray-50">
                    <h3 class="font-bold text-gray-600 text-sm tracking-widest uppercase flex items-center gap-2"> ğŸ“… æ”å–æ˜ç´°</h3>
                    <button onclick="openFoodModal('add')" class="text-xs bg-black text-white px-3 py-1.5 rounded-lg font-bold hover:bg-gray-800 active:scale-95 transition-all flex items-center gap-1 shadow-sm">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> æ–°å¢
                    </button>
                </div>
                <div onclick="toggleLog()" class="px-5 py-2 flex justify-center cursor-pointer hover:bg-gray-50">
                    <svg id="log-arrow" class="w-5 h-5 text-gray-300 transform transition-transform duration-300 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="log-content" class="px-5 pb-5 block space-y-3">
                    <div class="text-center text-gray-400 text-sm py-8 bg-gray-50 rounded-xl border border-dashed border-gray-200">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <div class="mt-8 p-4 bg-gray-200 rounded-xl text-xs font-mono text-gray-600 break-all hidden">
                <p class="font-bold mb-1"> ğŸ› ï¸ Debug Info [v18.0]</p>
                <p>User ID: <span id="debug-userid" class="text-blue-600">Detecting...</span></p>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 z-40">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleSettings(false)"></div>
        <div class="absolute bottom-0 w-full max-w-md bg-white rounded-t-3xl p-6 shadow-2xl modal-content transform translate-y-full transition-transform duration-300 left-1/2 -translate-x-1/2">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800"> âš™ï¸ è¨­å®šèº«é«”æ•¸å€¼</h3>
                <div onclick="toggleSettings(false)" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 cursor-pointer"><svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>
            </div>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto no-scrollbar pb-10">
                <div class="grid grid-cols-2 gap-4">
                    <label class="block"><span class="text-sm font-bold">æ€§åˆ¥</span><select id="input-gender" class="mt-1 block w-full rounded-xl border p-3"><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select></label>
                    <label class="block"><span class="text-sm font-bold">å¹´é½¡</span><input type="number" id="input-age" class="mt-1 block w-full rounded-xl border p-3" value="25"></label>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <label class="block"><span class="text-sm font-bold">èº«é«˜</span><input type="number" id="input-height" class="mt-1 block w-full rounded-xl border p-3" value="175"></label>
                    <label class="block"><span class="text-sm font-bold">é«”é‡</span><input type="number" id="input-weight" class="mt-1 block w-full rounded-xl border p-3" value="70"></label>
                </div>
                <div class="p-4 bg-green-50 rounded-xl border border-green-100"><label class="block"><span class="text-sm font-bold text-green-800"> ğŸ¯ ç›®æ¨™é«”é‡</span><input type="number" id="input-target-weight" class="mt-1 block w-full rounded-xl border border-green-200 p-3" placeholder="ä¾‹å¦‚: 65"></label></div>
                <label class="block"><span class="text-sm font-bold">é«”è„‚ç‡ %</span><input type="number" id="input-bodyfat" class="mt-1 block w-full rounded-xl border p-3" placeholder="é¸å¡«"></label>
                <label class="block"><span class="text-sm font-bold">é‹å‹•é »ç‡</span><select id="input-activity" class="mt-1 block w-full rounded-xl border p-3">
                    <option value="1.2">å¹¾ä¹ä¸é‹å‹• (è¾¦å…¬å®¤æ—)</option>
                    <option value="1.375">è¼•åº¦ (æ¯é€±é‹å‹• 1-3 å¤©)</option>
                    <option value="1.55">ä¸­åº¦ (æ¯é€±é‹å‹• 3-5 å¤©)</option>
                    <option value="1.725">é«˜åº¦ (æ¯é€±é‹å‹• 6-7 å¤©)</option>
                </select></label>
                <label class="block"><span class="text-sm font-bold">ç›®æ¨™</span><select id="input-goal" class="mt-1 block w-full rounded-xl border p-3"><option value="0.85">æ¸›è„‚</option><option value="1.0" selected>ç¶­æŒ</option><option value="1.10">å¢è‚Œ</option></select></label>
                <button type="button" onclick="saveProfile()" class="w-full bg-black text-white font-bold py-4 rounded-xl mt-4 hover:scale-[1.02] transition-transform active:scale-95">è¨ˆç®—ä¸¦å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="food-modal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeFoodModal()"></div>
        <div class="absolute bottom-0 w-full max-w-md bg-white rounded-t-3xl p-6 shadow-2xl modal-content transform translate-y-full transition-transform duration-300 left-1/2 -translate-x-1/2">
            <div class="flex justify-between items-center mb-6">
                <h3 id="food-modal-title" class="text-xl font-bold text-gray-800"> ğŸ½ï¸ æ–°å¢ç´€éŒ„</h3>
                <div onclick="closeFoodModal()" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200 cursor-pointer"><svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></div>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="food-id">
                <label class="block"><span class="text-sm font-bold">é£Ÿç‰©åç¨±</span><input type="text" id="food-name" class="mt-1 block w-full rounded-xl border p-3" placeholder="ä¾‹å¦‚: é›èƒ¸è‚‰"></label>
                <div class="grid grid-cols-2 gap-4">
                    <label class="block"><span class="text-sm font-bold text-orange-600"> ğŸ”¥ ç†±é‡</span><input type="number" id="food-cal" class="mt-1 block w-full rounded-xl border p-3 bg-orange-50"></label>
                    <label class="block"><span class="text-sm font-bold text-blue-600"> ğŸ¥š è›‹ç™½è³ª</span><input type="number" id="food-pro" class="mt-1 block w-full rounded-xl border p-3 bg-blue-50"></label>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <label class="block"><span class="text-sm font-bold text-green-600"> ğŸš ç¢³æ°´</span><input type="number" id="food-carb" class="mt-1 block w-full rounded-xl border p-3 bg-green-50"></label>
                    <label class="block"><span class="text-sm font-bold text-yellow-600"> ğŸ¥‘ è„‚è‚ª</span><input type="number" id="food-fat" class="mt-1 block w-full rounded-xl border p-3 bg-yellow-50"></label>
                </div>
                <button type="button" onclick="submitFood()" class="w-full bg-black text-white font-bold py-4 rounded-xl mt-4 hover:scale-[1.02] transition-transform active:scale-95">å„²å­˜ç´€éŒ„</button>
            </div>
        </div>
    </div>

    <script>
        const LIFF_ID = '2008846678-Niw8fld9';
        const API_DASHBOARD = 'https://evann8n.app.n8n.cloud/webhook/fitness-dashboard';
        const LINE_BOT_ID = '@398jjbps';

        let currentUserId = ''; let currentLogs = [];
        let userTargets = { cal: 2000, pro: 150, carb: 200, fat: 60 };
        let userProfile = {}; let currentEditingMode = 'add';
        let currentDate = new Date(); let selectedDateStr = formatDate(currentDate);

        window.onerror = function(msg, url, line) { console.error('JS Error:', msg); };

        window.onload = async function() {
            renderDateNav();
            try {
                const t = localStorage.getItem('userTargets'); if (t && JSON.parse(t).cal > 100) userTargets = JSON.parse(t);
                const p = localStorage.getItem('userProfile'); if (p) { userProfile = JSON.parse(p); populateProfileForm(userProfile); updateStatsCard(); }
            } catch(e) {}
            renderDashboard();
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const p = await liff.getProfile(); currentUserId = p.userId;
                    document.getElementById('debug-userid').innerText = currentUserId; fetchData('init');
                } else { liff.login(); }
            } catch (err) { console.error(err); }
        };

        function formatDate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        function renderDateNav() {
            const c = document.getElementById('date-nav-container'); c.innerHTML = '';
            for (let i = -3; i <= 3; i++) {
                const d = new Date(); d.setDate(d.getDate() + i); const ds = formatDate(d);
                const div = document.createElement('div');
                div.className = `date-item flex flex-col items-center justify-center min-w-[50px] h-[60px] rounded-xl cursor-pointer ${ds===selectedDateStr?'active':'bg-gray-50 text-gray-400 hover:bg-gray-100'}`;
                div.onclick = () => { currentDate = d; selectedDateStr = ds; renderDateNav(); document.getElementById('display-date-title').innerText=isToday(d)?'ä»Šæ—¥':`${d.getMonth()+1}/${d.getDate()}`; fetchData('date'); };
                div.innerHTML = `<span class="text-[10px] font-bold">${['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][d.getDay()]}</span><span class="text-xl font-bold">${d.getDate()}</span>`;
                c.appendChild(div);
            }
        }
        function isToday(d) { const t = new Date(); return d.getDate()===t.getDate() && d.getMonth()===t.getMonth(); }
        async function fetchData() {
            showLoading(true);
            try {
                const url = new URL(API_DASHBOARD);
                url.searchParams.append('userId', currentUserId); url.searchParams.append('user_id', currentUserId); url.searchParams.append('date', selectedDateStr);
                const res = await fetch(url); const data = await res.json();
                currentLogs = data.logs || [];
                if(data.targets && data.targets.cal > 100) userTargets = { ...userTargets, ...data.targets };
                renderDashboard(); renderLogs();
            } catch (e) { document.getElementById('log-content').innerHTML = '<div class="text-center text-red-400 py-4">é€£ç·šéŒ¯èª¤</div>'; } finally { showLoading(false); }
        }
        function renderDashboard() {
            let t = { cal: 0, pro: 0, carb: 0, fat: 0 };
            currentLogs.forEach(i => {
                t.cal += Number(i.calories||i.cal||0) || 0; t.pro += Number(i.protein||i.pro||0) || 0;
                t.carb += Number(i.carbs||i.carb||0) || 0; t.fat += Number(i.fat||0) || 0;
            });
            updateStat('cal', t.cal, userTargets.cal); updateStat('pro', t.pro, userTargets.pro);
            updateStat('carb', t.carb, userTargets.carb); updateStat('fat', t.fat, userTargets.fat);
            updateStatsCard();
        }
        function updateStat(k, v, g) {
            const safeG = g > 0 ? g : 2000; const p = Math.min(100, Math.round((v/safeG)*100));
            document.getElementById(`val-${k}`).innerText = Math.round(v);
            document.getElementById(`goal-${k}`).innerText = Math.round(g);
            document.getElementById(`percent-${k}`).innerText = `${p}%`;
            document.getElementById(`bar-${k}`).style.width = `${p}%`;
        }
        function updateStatsCard() {
            document.getElementById('disp-tdee').innerText = Math.round(userTargets.cal);
            document.getElementById('disp-weight').innerText = userProfile.weight || '--';
            if(userProfile.weight && userProfile.height && userProfile.age) {
                const w=Number(userProfile.weight), h=Number(userProfile.height), a=Number(userProfile.age);
                const bmr = (userProfile.gender==='male')?(10*w+6.25*h-5*a+5):(10*w+6.25*h-5*a-161);
                document.getElementById('disp-bmr').innerText = Math.round(bmr);
            }
        }

        // ========================
        // Helper: æ•¸æ“šå®‰å…¨è¡›å£«
        // ========================
        function safeNum(val) { const n = Number(val); return (isNaN(n) || !isFinite(n)) ? 0 : n; }
        function safePct(val, total) { 
            if(!total || total <= 0) return "0%";
            let p = (val / total) * 100;
            if(isNaN(p) || !isFinite(p)) p = 0;
            return Math.min(100, Math.max(0, Math.round(p))) + "%"; 
        }

        // ========================
        // [Feature 1] åŸå§‹ç‰ˆæˆ°å ± (RPG / éŠæˆ²åŒ–)
        // ========================
        async function shareAchievement() {
            if (!liff.isInClient()) { alert('è«‹åœ¨ LINE App ä¸­ä½¿ç”¨'); return; }
            if (!liff.isLoggedIn()) { liff.login(); return; }
            try {
                let uName = 'å¥åº·æˆ°å£«';
                try { const p = await liff.getProfile(); if(p.displayName) uName = p.displayName.substring(0,10).replace(/["'\\]/g,""); } catch(e){}
                
                let t = { cal: 0, pro: 0, carb: 0, fat: 0 };
                currentLogs.forEach(i => {
                    t.cal += safeNum(i.calories || i.cal);
                    t.pro += safeNum(i.protein || i.pro);
                    t.carb += safeNum(i.carbs || i.carb);
                    t.fat += safeNum(i.fat);
                });

                const gCal = Math.max(1, safeNum(userTargets.cal) || 2000);
                const gPro = Math.max(1, safeNum(userTargets.pro) || 100);
                const gCarb = Math.max(1, safeNum(userTargets.carb) || 200);
                const gFat = safeNum(userTargets.fat) || 60;

                let score = 0;
                const rCal = t.cal / gCal;
                if(rCal >= 0.9 && rCal <= 1.1) score += 50;
                else { const d = Math.abs(1-rCal)-0.1; score += (d>0)? Math.max(0, 50-(d*100)) : 50; }
                const rPro = t.pro / gPro;
                score += (rPro >= 0.9) ? 30 : (rPro/0.9)*30;
                score += 20;
                score = Math.round(Math.min(100, score));
                if(isNaN(score)) score = 0;

                // RPG ç¨±è™Ÿé‚è¼¯ (ä¿ç•™åŸå‘³)
                let rpgTitle = " ğŸŒ± å¥åº·åˆå¿ƒè€…"; let titleColor = "#555555";
                if (score >= 90) { rpgTitle = " ğŸ‘‘ å‚³èªªä¸­çš„é£²é£Ÿå¤§å¸«"; titleColor = "#EAB308"; }
                else if (t.pro > gPro * 1.2) { rpgTitle = " âš”ï¸ è‚Œè‚‰ç‹‚æˆ°å£«"; titleColor = "#3B82F6"; }
                else if (t.carb > gCarb * 1.2) { rpgTitle = " ğŸª„ æ¾±ç²‰é­”æ³•å¸«"; titleColor = "#22C55E"; }
                else if (t.fat > gFat * 1.2) { rpgTitle = " ğŸ§ˆ é…®é«”ç…‰é‡‘è¡“å£«"; titleColor = "#F59E0B"; }
                else if (t.cal < gCal * 0.7) { rpgTitle = " ğŸ§˜ ä½›ç³»ä¿®ç…‰è€…"; titleColor = "#8B5CF6"; }
                else if (score >= 80) { rpgTitle = " ğŸŒŸ å‡è¡¡æ¨¡ç¯„ç”Ÿ"; titleColor = "#10B981"; }

                let rank='C', color='#FF6B6B', text='ç¹¼çºŒåŠ æ²¹';
                if(score>=90){ rank='S'; color='#EAB308'; text='å®Œç¾åŸ·è¡Œ'; }
                else if(score>=80){ rank='A'; color='#1DB446'; text='è¡¨ç¾å„ªç•°'; }
                else if(score>=60){ rank='B'; color='#4B90E2'; text='é‚„ä¸éŒ¯'; }

                const pCal = safePct(t.cal, gCal);
                const pPro = safePct(t.pro, gPro);

                const messages = [{
                    type: "flex",
                    altText: ` ğŸ“… ${selectedDateStr} é£²é£Ÿæˆ°å ±ï¼š${rpgTitle}`,
                    contents: {
                        "type": "bubble",
                        "size": "giga", // å®‰å…¨èª¿æ•´: mega -> giga (åŠŸèƒ½ç›¸åŒä½†æ›´ç©©å®š)
                        "header": {
                            "type": "box", "layout": "horizontal",
                            "contents": [
                                { "type": "text", "text": " ğŸ“… é£²é£Ÿæ‰“å¡æ—¥å ±", "color": "#aaaaaa", "size": "xs" },
                                { "type": "text", "text": selectedDateStr, "color": "#aaaaaa", "size": "xs", "align": "end" }
                            ]
                        },
                        "hero": {
                            "type": "box", "layout": "vertical",
                            "contents": [
                                { "type": "text", "text": String(score), "size": "4xl", "weight": "bold", "color": color, "align": "center" }, // å®‰å…¨èª¿æ•´: 5xl -> 4xl
                                { "type": "text", "text": `${rank}ç´š - ${text}`, "size": "xl", "weight": "bold", "color": "#555555", "align": "center", "margin": "md" }
                            ], "paddingBottom": "20px"
                        },
                        "body": {
                            "type": "box", "layout": "vertical",
                            "contents": [
                                { "type": "text", "text": ` ğŸ‘¤ ${uName}`, "weight": "bold", "size": "md" },
                                { "type": "text", "text": rpgTitle, "size": "lg", "weight": "bold", "color": titleColor, "margin": "xs" },
                                { "type": "separator", "margin": "lg" },
                                { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", "contents": [
                                    { "type": "box", "layout": "horizontal", "contents": [
                                        { "type": "text", "text": " ğŸ”¥ ç†±é‡", "size": "sm", "color": "#555555", "flex": 2 },
                                        { "type": "text", "text": `${Math.round(t.cal)} / ${gCal}`, "size": "sm", "color": "#111111", "align": "end", "flex": 3 }
                                    ]},
                                    { "type": "box", "layout": "vertical", "width": "100%", "backgroundColor": "#F3F4F6", "height": "6px", "cornerRadius": "md", "contents": [
                                        { "type": "box", "layout": "vertical", "width": pCal, "backgroundColor": "#F97316", "height": "6px", "cornerRadius": "md" }
                                    ]}
                                ]},
                                { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", "contents": [
                                    { "type": "box", "layout": "horizontal", "contents": [
                                        { "type": "text", "text": " ğŸ¥š è›‹ç™½è³ª", "size": "sm", "color": "#555555", "flex": 2 },
                                        { "type": "text", "text": `${Math.round(t.pro)} / ${gPro}g`, "size": "sm", "color": "#111111", "align": "end", "flex": 3 }
                                    ]},
                                    { "type": "box", "layout": "vertical", "width": "100%", "backgroundColor": "#F3F4F6", "height": "6px", "cornerRadius": "md", "contents": [
                                        { "type": "box", "layout": "vertical", "width": pPro, "backgroundColor": "#3B82F6", "height": "6px", "cornerRadius": "md" }
                                    ]}
                                ]}
                            ]
                        },
                        "footer": {
                            "type": "box", "layout": "vertical",
                            "contents": [
                                { "type": "button", "style": "primary", "color": "#000000", "action": { "type": "uri", "label": "æˆ‘ä¹Ÿè¦æ¸¬æ¸¬çœ‹", "uri": `https://line.me/R/ti/p/${LINE_BOT_ID}` } }
                            ], "paddingAll": "20px"
                        }
                    }
                }];
                await liff.shareTargetPicker(messages);
            } catch (e) { console.error(e); alert('ç™¼é€å¤±æ•—: ' + e.message); }
        }

        // ========================
        // [Feature 2] å°ˆæ¥­æ•™ç·´å ±å‘Š (B2B / æ•¸æ“šå°å‘)
        // ========================
        async function shareCoachReport() {
            if (!liff.isInClient()) { alert('è«‹åœ¨ LINE App ä¸­ä½¿ç”¨'); return; }
            if (!liff.isLoggedIn()) { liff.login(); return; }
            try {
                let uName = 'å­¸å“¡';
                try { const p = await liff.getProfile(); if(p.displayName) uName = p.displayName.substring(0,10).replace(/["'\\]/g,""); } catch(e){}
                
                let t = { cal: 0, pro: 0 };
                let foodListText = "";
                currentLogs.forEach((item, index) => {
                    const cal = safeNum(item.calories || item.cal);
                    t.cal += cal;
                    t.pro += safeNum(item.protein || item.pro);
                    if (index < 10) foodListText += `â€¢ ${item.food_name || 'é¤é»'} (${Math.round(cal)})\n`;
                });
                if(currentLogs.length > 10) foodListText += "...æ›´å¤š";
                if(foodListText === "") foodListText = "æœ¬æ—¥ç„¡ç´€éŒ„";

                const gCal = Math.max(1, safeNum(userTargets.cal) || 2000);
                const diffCal = Math.round(t.cal - gCal);

                const messages = [{
                    type: "flex",
                    altText: `ğŸ“‹ æ•™ç·´æ—¥å ± ${uName}`,
                    contents: {
                        "type": "bubble",
                        "size": "giga",
                        "header": {
                            "type": "box", "layout": "vertical",
                            "contents": [
                                { "type": "text", "text": "NUTRITION REPORT", "weight": "bold", "color": "#333333", "align": "center" },
                                { "type": "text", "text": `${selectedDateStr} | ${uName}`, "size": "xs", "color": "#555555", "align": "center", "margin": "sm" }
                            ], "backgroundColor": "#f3f4f6"
                        },
                        "body": {
                            "type": "box", "layout": "vertical",
                            "contents": [
                                { "type": "box", "layout": "horizontal", "contents": [
                                    { "type": "text", "text": " ğŸ”¥ ç†±é‡", "weight": "bold", "flex": 1, "size": "sm" },
                                    { "type": "text", "text": `${Math.round(t.cal)} / ${gCal}`, "align": "end", "flex": 2, "size": "sm" },
                                    { "type": "text", "text": (diffCal>0?`+${diffCal}`:`${diffCal}`), "color": diffCal<=0?"#1DB446":"#FF6B6B", "align": "end", "flex": 1, "size": "sm" }
                                ], "margin": "md" },
                                { "type": "separator", "margin": "lg" },
                                { "type": "text", "text": "æ‘˜è¦:", "size": "xs", "color": "#aaaaaa", "margin": "md" },
                                { "type": "text", "text": foodListText, "size": "xs", "wrap": true, "margin": "sm", "color": "#333333" }
                            ]
                        }
                    }
                }];
                await liff.shareTargetPicker(messages);
            } catch (e) { alert("ç„¡æ³•ç”Ÿæˆå ±å‘Šï¼š" + e.message); }
        }

        // CRUD (ä¿æŒä¸è®Š)
        function deleteItem(e, id, name) {
            if(e){e.stopPropagation();e.preventDefault();} if(!confirm(`åˆªé™¤ ${name}?`))return;
            currentLogs=currentLogs.filter(i=>(i.id||i.row_number)!==id); renderDashboard(); renderLogs();
            fetch(API_DASHBOARD, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:currentUserId, id, action:'delete'})});
        }
        function openFoodModal(m, i) {
            currentEditingMode=m; const md=document.getElementById('food-modal'); const c=md.querySelector('.modal-content');
            document.getElementById('food-modal-title').innerText = m==='edit'?' âœï¸ ç·¨è¼¯':' ğŸ½ï¸ æ–°å¢';
            ['id','name','cal','pro','carb','fat'].forEach(k=>document.getElementById(`food-${k}`).value = (m==='edit'&&i)?(i[k]||i[k=='name'?'name':k]||''):'');
            md.classList.remove('hidden'); setTimeout(()=>c.classList.remove('translate-y-full'),10);
        }
        function closeFoodModal() { const md=document.getElementById('food-modal'); md.querySelector('.modal-content').classList.add('translate-y-full'); setTimeout(()=>md.classList.add('hidden'),300); }
        async function submitFood() {
            const n=document.getElementById('food-name').value; if(!n){alert('è«‹è¼¸å…¥åç¨±');return;}
            showLoading(true); closeFoodModal();
            const body = { userId:currentUserId, action:currentEditingMode==='edit'?'edit':'add_manual', date:selectedDateStr, food_name:n };
            ['id','cal','pro','carb','fat'].forEach(k=>{
                const v=document.getElementById(`food-${k}`).value;
                if(k==='id') body.id=v; else body[k==='cal'?'calories':k==='pro'?'protein':k==='carb'?'carbs':k] = Number(v);
            });
            try { await fetch(API_DASHBOARD,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); setTimeout(()=>fetchData(),1500); }
            catch(e){alert('å¤±æ•—');} finally{showLoading(false);}
        }
        function renderLogs() {
            const c=document.getElementById('log-content'); c.innerHTML=''; if(currentLogs.length===0){c.innerHTML='<div class="text-center text-gray-400 py-8">ç„¡ç´€éŒ„</div>';return;}
            [...currentLogs].reverse().forEach(i=>{
                const n=i.food_name||i.name, cal=Math.round(i.calories||0), p=Math.round(i.protein||0), c_val=Math.round(i.carbs||0), f=Math.round(i.fat||0), id=i.id||i.row_number;
                const iJson=JSON.stringify({id,name:n.replace(/"/g,""),cal,p,c:c_val,f}).replace(/"/g,'&quot;');
                c.insertAdjacentHTML('beforeend', `
                <div class="flex justify-between items-center py-4 border-b border-gray-100 px-2 hover:bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3"><div class="bg-gray-100 p-2.5 rounded-xl text-xl"> ğŸ½ï¸ </div><div><div class="font-bold text-gray-800 text-sm">${n}</div><div class="text-xs text-gray-500 mt-1"><span class="text-orange-500 font-bold">${cal} kcal</span> C:${c_val} P:${p} F:${f}</div></div></div>
                <div class="flex gap-1">${id?`<button onclick="openFoodModal('edit',${iJson})" class="p-2 text-gray-400 hover:text-blue-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button><button onclick="deleteItem(event,'${id}','${n}')" class="p-2 text-gray-400 hover:text-red-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`:''}</div>
                </div>`);
            });
        }
        function populateProfileForm(p){ ['gender','age','height','weight','activity'].forEach(k=>document.getElementById(`input-${k}`).value=p[k]||''); }
        async function saveProfile(){
            showLoading(true); const p={}; ['gender','age','height','weight','activity','target-weight','bodyfat','goal'].forEach(k=>p[k]=document.getElementById(`input-${k}`).value);
            const w=Number(p.weight), h=Number(p.height), a=Number(p.age), act=Number(p.activity), g=Number(p.goal);
            const bmr=(p.gender==='male')?(10*w+6.25*h-5*a+5):(10*w+6.25*h-5*a-161);
            const tdee=Math.round(bmr*act*g);
            userTargets={cal:tdee, pro:Math.round(tdee*0.25/4), carb:Math.round(tdee*0.5/4), fat:Math.round(tdee*0.25/9)};
            userProfile={...p, weight:w, height:h, age:a};
            localStorage.setItem('userTargets',JSON.stringify(userTargets)); localStorage.setItem('userProfile',JSON.stringify(userProfile));
            toggleSettings(false); renderDashboard(); updateStatsCard();
            try{await fetch(API_DASHBOARD,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:currentUserId,action:'update_profile',...p,tdee_goal:tdee,target_protein:userTargets.pro,target_carbs:userTargets.carb,target_fat:userTargets.fat})}); alert('å·²æ›´æ–°');}catch(e){}finally{showLoading(false);}
        }
        function showLoading(s){document.getElementById('loading-overlay').classList.toggle('hidden',!s);}
        function toggleSettings(s){const m=document.getElementById('settings-modal'); if(s){m.classList.remove('hidden');setTimeout(()=>m.querySelector('.modal-content').classList.remove('translate-y-full'),10);}else{m.querySelector('.modal-content').classList.add('translate-y-full');setTimeout(()=>m.classList.add('hidden'),300);}}
        function toggleLog(){const c=document.getElementById('log-content');c.classList.toggle('hidden');}
    </script>
</body>
</html>
