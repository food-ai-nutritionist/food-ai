// [V16.1 Fix] ä¿®å¾©ç‰ˆåˆ†äº«å‡½å¼
        async function shareAchievement() {
            if (!liff.isInClient()) { alert('è«‹åœ¨ LINE App ä¸­ä½¿ç”¨'); return; }
            // ç¢ºä¿å·²ç™»å…¥
            if (!liff.isLoggedIn()) { 
                liff.login(); 
                return; 
            }

            try {
                // 1. å®‰å…¨å–å¾—ç”¨æˆ¶åç¨± (é˜²æ­¢åå­—æœ‰ç‰¹æ®Šç¬¦è™Ÿå°è‡´ JSON å£æ‰)
                let userName = 'å¥åº·æˆ°å£«';
                try { 
                    const profile = await liff.getProfile(); 
                    // åªå–å‰ 10 å€‹å­—ï¼Œä¸¦ç§»é™¤å¯èƒ½çš„å¼•è™Ÿ
                    if(profile.displayName) {
                        userName = profile.displayName.substring(0, 10).replace(/["'\\]/g, "");
                    }
                } catch(e) { console.log('Profile Error', e); }

                // 2. è¨ˆç®—æ•¸å€¼ (ç¢ºä¿æ˜¯æ•¸å­—)
                let totals = { cal: 0, pro: 0, carb: 0, fat: 0 };
                currentLogs.forEach(item => {
                    totals.cal += Number(item.calories || 0);
                    totals.pro += Number(item.protein || 0);
                    totals.carb += Number(item.carbs || 0);
                    totals.fat += Number(item.fat || 0);
                });

                // 3. ç°¡å–®è©•åˆ† (é˜²æ­¢é™¤ä»¥ 0)
                const safeTargetCal = userTargets.cal || 2000;
                const safeTargetPro = userTargets.pro || 100;
                const safeTargetCarb = userTargets.carb || 200;

                let score = 0;
                // ç†±é‡ (50åˆ†)
                const calRatio = totals.cal / safeTargetCal;
                if (calRatio >= 0.9 && calRatio <= 1.1) score += 50;
                else {
                    const diff = Math.abs(1 - calRatio) - 0.1;
                    if (diff > 0) score += Math.max(0, 50 - (diff * 100));
                    else score += 50;
                }
                // è›‹ç™½è³ª (30åˆ†)
                if ((totals.pro / safeTargetPro) >= 0.9) score += 30;
                else score += ((totals.pro / safeTargetPro) / 0.9) * 30;
                // å…¶ä»– (20åˆ†)
                score += 20; // ç°¡åŒ–é‚è¼¯ï¼Œé¼“å‹µç‚ºä¸»
                
                score = Math.round(Math.min(100, score));
                if (isNaN(score)) score = 0; // çµ‚æ¥µé˜²è­·

                // 4. ç­‰ç´šèˆ‡é¡è‰²
                let rank = 'C';
                let rankColor = '#FF6B6B'; // Red
                let rankText = 'ç¹¼çºŒåŠ æ²¹';
                
                if (score >= 90) { rank = 'S'; rankColor = '#Eab308'; rankText = 'å®Œç¾åŸ·è¡Œ'; } // Gold (ç”¨æ·±é»ƒè‰²é¿å…å¤ªäº®)
                else if (score >= 80) { rank = 'A'; rankColor = '#1DB446'; rankText = 'è¡¨ç¾å„ªç•°'; } // Green
                else if (score >= 60) { rank = 'B'; rankColor = '#4B90E2'; rankText = 'é‚„ä¸éŒ¯'; } // Blue

                // 5. è¨ˆç®—ç™¾åˆ†æ¯” (ç”¨æ–¼é€²åº¦æ¢) - ç¢ºä¿æ˜¯å­—ä¸²ä¸”æœ‰ %
                const calPct = Math.min(100, Math.round((totals.cal / safeTargetCal) * 100)) + "%";
                const proPct = Math.min(100, Math.round((totals.pro / safeTargetPro) * 100)) + "%";
                const carbPct = Math.min(100, Math.round((totals.carb / safeTargetCarb) * 100)) + "%";

                // 6. å»ºæ§‹ Flex Message (ç°¡åŒ–çµæ§‹ä»¥ç¢ºä¿æˆåŠŸ)
                const flexMessage = {
                    type: "flex",
                    altText: `ğŸ“… ${selectedDateStr} é£²é£Ÿæˆ°å ±`,
                    contents: {
                        "type": "bubble",
                        "size": "mega",
                        "header": {
                            "type": "box",
                            "layout": "horizontal",
                            "contents": [
                                { "type": "text", "text": "ğŸ“… é£²é£Ÿæ‰“å¡æ—¥å ±", "color": "#aaaaaa", "size": "xs" },
                                { "type": "text", "text": selectedDateStr, "color": "#aaaaaa", "size": "xs", "align": "end" }
                            ]
                        },
                        "hero": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                { "type": "text", "text": `${score}`, "size": "5xl", "weight": "bold", "color": rankColor, "align": "center" },
                                { "type": "text", "text": `${rank}ç´š - ${rankText}`, "size": "xl", "weight": "bold", "color": "#555555", "align": "center", "margin": "md" }
                            ],
                            "paddingBottom": "20px"
                        },
                        "body": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                { "type": "text", "text": `ğŸ‘¤ ${userName}`, "weight": "bold", "size": "md" },
                                { "type": "separator", "margin": "lg" },
                                
                                // ç†±é‡æ¢
                                { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", "contents": [
                                    { "type": "box", "layout": "horizontal", "contents": [
                                        { "type": "text", "text": "ğŸ”¥ ç†±é‡", "size": "sm", "color": "#555555", "flex": 2 },
                                        { "type": "text", "text": `${Math.round(totals.cal)} / ${safeTargetCal}`, "size": "sm", "color": "#111111", "align": "end", "flex": 3 }
                                    ]},
                                    { "type": "box", "layout": "vertical", "width": "100%", "backgroundColor": "#F3F4F6", "height": "6px", "cornerRadius": "3px", "contents": [
                                        { "type": "box", "layout": "vertical", "width": calPct, "backgroundColor": "#F97316", "height": "6px", "cornerRadius": "3px" }
                                    ]}
                                ]},

                                // è›‹ç™½è³ªæ¢
                                { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", "contents": [
                                    { "type": "box", "layout": "horizontal", "contents": [
                                        { "type": "text", "text": "ğŸ¥š è›‹ç™½è³ª", "size": "sm", "color": "#555555", "flex": 2 },
                                        { "type": "text", "text": `${Math.round(totals.pro)} / ${safeTargetPro}g`, "size": "sm", "color": "#111111", "align": "end", "flex": 3 }
                                    ]},
                                    { "type": "box", "layout": "vertical", "width": "100%", "backgroundColor": "#F3F4F6", "height": "6px", "cornerRadius": "3px", "contents": [
                                        { "type": "box", "layout": "vertical", "width": proPct, "backgroundColor": "#3B82F6", "height": "6px", "cornerRadius": "3px" }
                                    ]}
                                ]}
                            ]
                        },
                        "footer": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "button",
                                    "style": "primary",
                                    "action": {
                                        "type": "uri",
                                        "label": "æŸ¥çœ‹è©³ç´°å„€è¡¨æ¿",
                                        "uri": `https://liff.line.me/${LIFF_ID}`
                                    }
                                }
                            ],
                            "paddingAll": "20px"
                        }
                    }
                };

                // 7. ç™¼é€
                const result = await liff.shareTargetPicker([flexMessage]);
                if (result) {
                    console.log("åˆ†äº«æˆåŠŸ");
                } else {
                    console.log("ä½¿ç”¨è€…å–æ¶ˆåˆ†äº«");
                }

            } catch (error) {
                console.error('åˆ†äº«å¤±æ•—è©³ç´°éŒ¯èª¤:', error);
                // é¡¯ç¤ºå…·é«”éŒ¯èª¤ï¼Œå¹«åŠ©é™¤éŒ¯
                alert('ç™¼é€å¤±æ•—ï¼š' + (error.message || error));
            }
        }
