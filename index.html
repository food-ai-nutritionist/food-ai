<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI ç‡Ÿé¤Šå¸« - å¥åº·å„€è¡¨æ¿</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding-bottom: 40px; }
    .container { max-width: 600px; padding: 20px; }
    
    /* å„€è¡¨æ¿å¡ç‰‡ */
    .dashboard-card {
      background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .section-title { font-size: 1.2rem; font-weight: 700; color: #333; margin-bottom: 15px; border-left: 5px solid #28a745; padding-left: 10px; }
    
    /* é€²åº¦æ¢æ¨£å¼ */
    .progress-label { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; color: #555; }
    .progress { height: 12px; border-radius: 6px; background-color: #e9ecef; margin-bottom: 15px; }
    .progress-bar { border-radius: 6px; transition: width 1s ease-in-out; }
    .bg-cal { background-color: #ffc107; } /* ç†±é‡ é»ƒè‰² */
    .bg-pro { background-color: #28a745; } /* è›‹ç™½è³ª ç¶ è‰² */
    .bg-carb { background-color: #17a2b8; } /* ç¢³æ°´ è—è‰² */
    .bg-fat { background-color: #dc3545; } /* è„‚è‚ª ç´…è‰² */

    /* è¡¨å–®æ¨£å¼ */
    .form-label { font-weight: 600; color: #444; margin-top: 10px; }
    .form-control, .form-select { border-radius: 10px; border: 1px solid #ced4da; padding: 12px; }
    .btn-save { background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; margin-top: 20px; font-size: 1.1rem; box-shadow: 0 4px 6px rgba(40,167,69,0.2); }
    .btn-save:active { transform: scale(0.98); }

    /* Loading å‹•ç•« */
    #loading { display: none; text-align: center; padding: 50px 0; }
    .spinner-border { width: 3rem; height: 3rem; color: #28a745; }
    #dashboardArea, #formArea { display: none; } /* é è¨­éš±è—ï¼Œè¼‰å…¥å¾Œé¡¯ç¤º */
  </style>
</head>
<body>

<div class="container">
  <div id="loading">
    <div class="spinner-border" role="status"></div>
    <p class="mt-3 text-muted">æ­£åœ¨è®€å–æ‚¨çš„å¥åº·æ•¸æ“š...</p>
  </div>

  <div id="dashboardArea" class="dashboard-card">
    <div class="section-title">ğŸ“Š ä»Šæ—¥æ”å–é€²åº¦</div>
    
    <div class="progress-label">
      <span>ğŸ”¥ ç†±é‡ (Calories)</span>
      <span id="labelCal">0 / 0 kcal</span>
    </div>
    <div class="progress">
      <div id="barCal" class="progress-bar bg-cal" style="width: 0%"></div>
    </div>

    <div class="progress-label">
      <span>ğŸ¥š è›‹ç™½è³ª (Protein)</span>
      <span id="labelPro">0 / 0 g</span>
    </div>
    <div class="progress">
      <div id="barPro" class="progress-bar bg-pro" style="width: 0%"></div>
    </div>

    <div class="progress-label">
      <span>ğŸš ç¢³æ°´ (Carbs)</span>
      <span id="labelCarb">0 / 0 g</span>
    </div>
    <div class="progress">
      <div id="barCarb" class="progress-bar bg-carb" style="width: 0%"></div>
    </div>

    <div class="progress-label">
      <span>ğŸ¥‘ è„‚è‚ª (Fat)</span>
      <span id="labelFat">0 / 0 g</span>
    </div>
    <div class="progress">
      <div id="barFat" class="progress-bar bg-fat" style="width: 0%"></div>
    </div>
  </div>

  <div id="formArea" class="dashboard-card">
    <div class="section-title">âš™ï¸ è¨­å®šèº«é«”æ•¸å€¼</div>
    <form id="profileForm">
      <div class="row">
        <div class="col-6">
          <label class="form-label">æ€§åˆ¥</label>
          <select class="form-select" id="gender">
            <option value="male">ç”·ç”Ÿ ğŸ™‹â€â™‚ï¸</option>
            <option value="female">å¥³ç”Ÿ ğŸ™‹â€â™€ï¸</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label">å¹´é½¡</label>
          <input type="number" class="form-control" id="age" placeholder="25">
        </div>
      </div>

      <div class="row mt-2">
        <div class="col-6">
          <label class="form-label">èº«é«˜ (cm)</label>
          <input type="number" class="form-control" id="height" placeholder="175">
        </div>
        <div class="col-6">
          <label class="form-label">é«”é‡ (kg)</label>
          <input type="number" class="form-control" id="weight" placeholder="70">
        </div>
      </div>
      
      <div class="row mt-2">
        <div class="col-6">
          <label class="form-label">é«”è„‚ç‡ (%)</label>
          <input type="number" class="form-control" id="bodyFat" placeholder="é¸å¡«">
        </div>
        <div class="col-6">
          <label class="form-label">è…°åœ (cm)</label>
          <input type="number" class="form-control" id="waistLine" placeholder="é¸å¡«">
        </div>
      </div>

      <label class="form-label">æ—¥å¸¸æ´»å‹•é‡</label>
      <select class="form-select" id="activity">
        <option value="1.2">ğŸ›Œ ä¹…å (å¹¾ä¹ä¸é‹å‹•)</option>
        <option value="1.375">ğŸš¶â€â™‚ï¸ è¼•åº¦ (æ¯é€±é‹å‹• 1-3 å¤©)</option>
        <option value="1.55">ğŸƒâ€â™‚ï¸ ä¸­åº¦ (æ¯é€±é‹å‹• 3-5 å¤©)</option>
        <option value="1.725">ğŸ‹ï¸â€â™‚ï¸ é«˜åº¦ (æ¯é€±é‹å‹• 6-7 å¤©)</option>
        <option value="1.9">ğŸ”¥ è¶…ç´š (å‹åŠ›å·¥ä½œ/é‹å‹•å“¡)</option>
      </select>

      <label class="form-label">ç›®æ¨™</label>
      <select class="form-select" id="goal">
        <option value="lose">ğŸ“‰ æ¸›è„‚ (ç†±é‡èµ¤å­— 15%)</option>
        <option value="maintain">âš–ï¸ ç¶­æŒ (TDEE å¹³è¡¡)</option>
        <option value="gain">ğŸ’ª å¢è‚Œ (ç†±é‡ç›ˆé¤˜ 10%)</option>
      </select>
      
      <label class="form-label">å‚™è¨» (éæ•/é£²é£Ÿåå¥½)</label>
      <input type="text" class="form-control" id="healthNotes" placeholder="ä¾‹å¦‚ï¼šä¸åƒç‰›ã€ä¹³ç³–ä¸è€">

      <button type="submit" class="btn-save" id="submitBtn">æ›´æ–°è¨­å®š</button>
    </form>
  </div>
</div>

<script>
  // ğŸ”´ è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„è³‡è¨Š ğŸ”´
  const LIFF_ID = "2006846678-Niw8fld9";  // ä½ çš„ LIFF ID
  const API_URL = "https://evann8n.app.n8n.cloud/webhook/fitness-dashboard"; // ä½ çš„ n8n æ­£å¼ç¶²å€
  // ğŸ”´ è¨­å®šçµæŸ ğŸ”´

  let userId = "";

  async function main() {
    document.getElementById('loading').style.display = 'block';
    
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }
      const profile = await liff.getProfile();
      userId = profile.userId;
      
      // 1. å‘¼å« n8n å–å¾—è³‡æ–™ (GET)
      fetchData(userId);

    } catch (err) {
      console.error('LIFF Init Failed', err);
      alert('LIFF åˆå§‹åŒ–å¤±æ•—ï¼š' + err.message);
    }
  }

  // å–å¾—è³‡æ–™ä¸¦æ›´æ–° UI
  function fetchData(uid) {
    fetch(`${API_URL}?user_id=${uid}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('loading').style.display = 'none';
        
        if (data.found) {
          // A. æ›´æ–°å„€è¡¨æ¿
          updateDashboard(data.progress);
          // B. å¡«å…¥è¡¨å–®èˆŠè³‡æ–™
          fillForm(data.profile);
          // é¡¯ç¤ºå€å¡Š
          document.getElementById('dashboardArea').style.display = 'block';
        } else {
          // æ²’è³‡æ–™ï¼Œåªé¡¯ç¤ºè¡¨å–®
          alert("æ­¡è¿æ–°æœ‹å‹ï¼è«‹å…ˆè¨­å®šæ‚¨çš„èº«é«”æ•¸å€¼ã€‚");
        }
        document.getElementById('formArea').style.display = 'block';
      })
      .catch(err => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('formArea').style.display = 'block'; // è‡³å°‘é¡¯ç¤ºè¡¨å–®è®“äººå¡«
        alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚");
      });
  }

  // æ›´æ–°å„€è¡¨æ¿ UI
  function updateDashboard(progress) {
    if(!progress) return;
    
    setBar('Cal', progress.today_calories, progress.goal_calories, progress.pct_calories);
    setBar('Pro', progress.today_protein, progress.goal_protein, progress.pct_protein);
    setBar('Carb', progress.today_carbs, progress.goal_carbs, progress.pct_carbs);
    setBar('Fat', progress.today_fat, progress.goal_fat, progress.pct_fat);
  }

  function setBar(type, current, goal, pct) {
    const bar = document.getElementById(`bar${type}`);
    const label = document.getElementById(`label${type}`);
    
    // é™åˆ¶æœ€å¤§ 100% é¿å…è·‘ç‰ˆï¼Œä½†å¦‚æœè¶…éå¯ä»¥ç”¨é¡è‰²è­¦ç¤º
    let width = pct > 100 ? 100 : pct;
    bar.style.width = `${width}%`;
    label.innerText = `${current} / ${goal} ${type==='Cal'?'kcal':'g'} (${pct}%)`;
    
    // è¶…æ¨™è­¦ç¤º (è®Šæˆç´…è‰²)
    if(pct > 100) bar.style.backgroundColor = '#dc3545'; 
  }

  // è‡ªå‹•å¡«å…¥è¡¨å–®
  function fillForm(profile) {
    if(!profile) return;
    document.getElementById('gender').value = profile.gender || 'male';
    document.getElementById('age').value = profile.age || '';
    document.getElementById('height').value = profile.height || '';
    document.getElementById('weight').value = profile.weight || '';
    document.getElementById('activity').value = profile.activity || '1.2';
    document.getElementById('goal').value = profile.goal || 'lose';
    // æ–°æ¬„ä½
    document.getElementById('bodyFat').value = profile.body_fat || '';
    document.getElementById('waistLine').value = profile.waist_line || '';
    document.getElementById('healthNotes').value = profile.health_notes || '';
  }

  // ç›£è½è¡¨å–®é€å‡º (POST)
  document.getElementById('profileForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerText = "æ›´æ–°ä¸­...";

    const formData = {
      user_id: userId,
      nickname: "User", // ä¹‹å¾Œå¯å¾ liff æŠ“æš±ç¨±
      gender: document.getElementById('gender').value,
      age: document.getElementById('age').value,
      height: document.getElementById('height').value,
      weight: document.getElementById('weight').value,
      activity: document.getElementById('activity').value,
      goal: document.getElementById('goal').value,
      body_fat: document.getElementById('bodyFat').value,
      waist_line: document.getElementById('waistLine').value,
      health_notes: document.getElementById('healthNotes').value
    };

    fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    })
    .then(res => res.json())
    .then(data => {
      alert("âœ… è¨­å®šæ›´æ–°æˆåŠŸï¼å„€è¡¨æ¿å·²åŒæ­¥æ›´æ–°ã€‚");
      location.reload(); // é‡æ–°æ•´ç†é é¢ä»¥çœ‹è¦‹æ–°æ•¸æ“š
    })
    .catch(err => {
      alert("âŒ æ›´æ–°å¤±æ•—ï¼š" + err);
      btn.disabled = false;
      btn.innerText = "æ›´æ–°è¨­å®š";
    });
  });

  main();
</script>

</body>
</html>
